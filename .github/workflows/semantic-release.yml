name: Frontend Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Push commits and tags
      issues: write # Create releases
      pull-requests: write # Comment on PRs

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install --force
      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Generate PR-based Release Notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # ============================================================================
          # Helper Functions
          # ============================================================================

          # Truncate PR body at horizontal rules or character limit with word boundaries
          truncate_pr_body() {
            local body="$1"
            local maxlen=2000
            
            echo "$body" | \
              awk '/^[-]{3,}$|^[*]{3,}$|^[_]{3,}$/ { exit } { print }' | \
              awk -v max="$maxlen" '
                BEGIN { text="" }
                {
                  if (length(text) + length($0) + 1 <= max) {
                    text = text (text ? "\n" : "") $0
                  } else if (length(text) < max - 20) {
                    remain = max - length(text) - 1
                    line = substr($0, 1, remain)
                    match(line, /.*[[:space:]]/)
                    text = text "\n" (RSTART ? substr(line, 1, RLENGTH) : line) "..."
                    exit
                  } else {
                    match(text, /.*[[:space:]]/)
                    text = (RSTART ? substr(text, 1, RLENGTH) : text) "..."
                    exit
                  }
                }
                END { print text }
              '
          }

          # Categorize PR by title prefix
          categorize_pr() {
            local title="$1"
            if echo "$title" | grep -qiE "^feat|feature|add|new"; then
              echo "feature"
            elif echo "$title" | grep -qiE "^fix|bug|resolve|hotfix"; then
              echo "fix"
            else
              echo "other"
            fi
          }

          # Append section to release notes
          append_section() {
            local title="$1"
            local content="$2"
            [ -n "$content" ] && {
              echo "" >> RELEASE_NOTES.md
              echo "## $title" >> RELEASE_NOTES.md
              echo "" >> RELEASE_NOTES.md
              echo "$content" >> RELEASE_NOTES.md
            }
          }

          # ============================================================================
          # Main Script
          # ============================================================================

          # Get tags and metadata
          git fetch --tags
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          [ -z "$CURRENT_TAG" ] && {
            echo "No tags found, skipping release notes generation"
            exit 0
          }

          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          DATE=$(date +"%B %d, %Y")
          COMMIT_RANGE="${PREVIOUS_TAG:+$PREVIOUS_TAG..}${CURRENT_TAG}"

          echo "ðŸ“¦ Release: $CURRENT_TAG (from ${PREVIOUS_TAG:-initial})"

          # Find PRs from commits
          COMMIT_SHAS=$(git log ${COMMIT_RANGE} --pretty=format:"%H" | head -50)
          PR_NUMBERS=$(
            for sha in $COMMIT_SHAS; do
              gh api "/repos/${{ github.repository }}/commits/${sha}/pulls" \
                --jq '.[0].number // empty' 2>/dev/null
            done | sort -u
          )

          echo "ðŸ” Found PRs: ${PR_NUMBERS:-none}"

          # Initialize release notes
          cat > RELEASE_NOTES.md << EOF
          # ðŸš€ Release Notes

          ## ${CURRENT_TAG}

          **Release Date:** ${DATE}

          ---
          EOF

          # Process PRs by category
          FEATURES="" FIXES="" OTHER=""

          for pr in $PR_NUMBERS; do
            echo "  Processing PR #$pr..."
            
            PR_DATA=$(gh pr view "$pr" --json title,body 2>/dev/null || continue)
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // "No title"')
            PR_BODY=$(echo "$PR_DATA" | jq -r '.body // ""')
            PR_BODY=$(truncate_pr_body "$PR_BODY")
            
            ENTRY="### PR #${pr}: ${PR_TITLE}

          ${PR_BODY}

          ---

          "
            
            case $(categorize_pr "$PR_TITLE") in
              feature) FEATURES="${FEATURES}${ENTRY}" ;;
              fix) FIXES="${FIXES}${ENTRY}" ;;
              *) OTHER="${OTHER}${ENTRY}" ;;
            esac
          done

          # Write categorized sections
          append_section "âœ¨ New Features" "$FEATURES"
          append_section "ðŸ› Bug Fixes" "$FIXES"
          append_section "ðŸ“¦ Other Changes" "$OTHER"

          # Fallback message if no PRs
          [ -z "$FEATURES$FIXES$OTHER" ] && cat >> RELEASE_NOTES.md << EOF

          No PR descriptions available for this release.

          See [CHANGELOG.md](./CHANGELOG.md) for commit details.
          EOF

          # Add footer
          cat >> RELEASE_NOTES.md << EOF

          ---

          ðŸ“‹ For detailed commit history, see [CHANGELOG.md](./CHANGELOG.md)

          ---

          *Auto-generated from PR descriptions.*
          EOF

          echo "âœ… RELEASE_NOTES.md generated"
          cat RELEASE_NOTES.md

      - name: Commit and Push Release Notes
        run: |
          [ ! -f RELEASE_NOTES.md ] && exit 0

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add RELEASE_NOTES.md

          git diff --staged --quiet || {
            git commit -m "docs: update RELEASE_NOTES.md [skip ci]"
            git push origin main
          }
